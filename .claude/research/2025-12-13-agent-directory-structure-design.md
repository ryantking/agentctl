# Design: .agent Directory Structure and Rule File Format

Date: 2025-12-13
Issue: feat-memory-base-commands-915
Parent Epic: feat-memory-base-commands-cw0

## Overview

The `.agent` directory provides a standardized structure for organizing agent instructions, rules, and project context. This design replaces the monolithic AGENTS.md/CLAUDE.md approach with a modular rules-based system.

## Directory Structure

```
.agent/
├── rules/              # Rule files (.mdc format with frontmatter)
│   ├── git-workflow.mdc
│   ├── beads-workflow.mdc
│   ├── tool-selection.mdc
│   └── ...
├── research/           # Research artifacts (cached findings)
│   └── YYYY-MM-DD-topic.md
└── project.md          # High-level repository description
```

### Environment Variable Override

The `AGENTDIR` environment variable can override the default `.agent` location:

```bash
export AGENTDIR=/path/to/custom/agent/dir
agentctl rules init  # Creates /path/to/custom/agent/dir/
```

**Use Cases:**
- Shared agent config across multiple repos
- Per-user agent customization
- CI/CD environments with custom paths

## Rule File Format (.mdc)

Rules are Markdown files with YAML frontmatter. The `.mdc` extension indicates "Markdown with frontmatter" (similar to Cursor's format).

### Frontmatter Schema

```yaml
---
name: "Rule Name"
description: "Brief description of what this rule covers"
when-to-use: "When should agents apply this rule?"
applies-to: ["claude", "cursor", "windsurf"]  # Which tools this applies to
priority: 1  # 0-4, 0=highest
tags: ["git", "workflow", "best-practices"]
version: "1.0.0"
---
```

### Required Fields

- `name`: Human-readable rule name
- `description`: One-line description
- `when-to-use`: Context for when this rule applies

### Optional Fields

- `applies-to`: List of tools this rule applies to. Default: all tools
- `priority`: 0-4, where 0 is highest priority. Default: 2
- `tags`: Array of tags for categorization
- `version`: Semantic version for rule evolution
- `depends-on`: Array of rule names this rule depends on
- `conflicts-with`: Array of rule names this rule conflicts with

### Body Content

The body contains the actual rule instructions in Markdown:

```markdown
## Rule Details

When working with git:

1. Always use conventional commits
2. Follow the branch naming convention
3. ...

## Examples

```bash
git commit -m "feat(scope): add new feature"
```
```

## Example Rule Files

### git-workflow.mdc

```yaml
---
name: "Git Workflow"
description: "Conventional commits and branch management"
when-to-use: "When committing changes or creating branches"
applies-to: ["claude", "cursor", "windsurf"]
priority: 1
tags: ["git", "workflow"]
version: "1.0.0"
---
```

[Git workflow content from AGENTS.md]

### beads-workflow.mdc

```yaml
---
name: "Beads Issue Tracking"
description: "Using bd (beads) for issue tracking"
when-to-use: "When tracking tasks or creating issues"
applies-to: ["claude"]
priority: 1
tags: ["beads", "issue-tracking"]
version: "1.0.0"
---
```

[Beads workflow content from AGENTS.md]

### tool-selection.mdc

```yaml
---
name: "Tool Selection Guidelines"
description: "When to use specialized tools vs bash commands"
when-to-use: "When deciding which tool to use for file operations"
applies-to: ["claude"]
priority: 1
tags: ["tools", "best-practices"]
version: "1.0.0"
---
```

[Tool selection content from AGENTS.md]

## project.md Format

The `project.md` file contains high-level repository context:

```markdown
# Repository Overview

**agentctl** is a CLI tool for managing Claude Code configurations, hooks, and isolated workspaces using git worktrees.

## Main Purpose

Provides workspace isolation, lifecycle hooks, and automation for Claude Code development workflows.

## Technologies

- Go 1.25+
- Cobra CLI framework
- Git worktrees

## Entry Points

- CLI: `cmd/agentctl/main.go`
- Commands: `internal/cli/`
```

This file is generated by `agentctl rules init` using Claude CLI (similar to current repository indexing).

## Integration Points

### Cursor Integration

Rules sync to `.cursor/rules/*.mdc` - Cursor automatically loads these files.

### Claude Code Integration

Rules sync to `.claude/skills/<name>/SKILL.md` - Each rule becomes a Claude skill that agents can invoke.

### AGENTS.md Generation

For non-Cursor/Claude agents, `agentctl rules sync` generates an AGENTS.md file with a table of contents listing all rules.

### CLAUDE.md Generation

For Claude Code, `agentctl rules sync` generates a simple CLAUDE.md that references available skills.

## Migration Path

1. Extract rules from current AGENTS.md template
2. Create default rules in `agentctl`'s `rules/` directory
3. `agentctl rules init` copies defaults to `.agent/rules/`
4. `agentctl rules sync` generates AGENTS.md/CLAUDE.md from rules
5. Deprecate old `agentctl memory` commands

## Benefits

- **Modularity**: Rules can be added/removed independently
- **Reusability**: Rules can be shared across projects
- **Tool-specific**: Rules can target specific tools
- **Versioning**: Rules can evolve independently
- **Composability**: Rules can depend on or conflict with each other

## Implementation Notes

### Rule Extraction Strategy

From current AGENTS.md template, extract:

1. **Git Workflow** (lines ~152-360)
   - Conventional commits specification
   - Branch creation
   - Local branch merging
   - Pull request creation
   - Pull request merging

2. **Beads Workflow** (if present)
   - Issue tracking with bd commands
   - Workflow patterns

3. **Tool Selection Guidelines** (lines ~491-673)
   - When to use Read/Grep/Glob vs Bash
   - File deletion guidelines
   - Bash command sequencing
   - Temporary files and directories
   - Anti-patterns

4. **Workspaces** (lines ~57-113)
   - Workspace management commands
   - Context injection

5. **Global Hooks** (lines ~114-151)
   - Context injection
   - Auto-commit behavior

### Frontmatter Validation

The `agentctl rules` commands should validate:
- Required fields are present
- `applies-to` values are valid tool names
- `priority` is 0-4
- `depends-on` and `conflicts-with` reference existing rules
- YAML frontmatter is valid

### File Naming Convention

Rule files should use kebab-case:
- `git-workflow.mdc`
- `beads-workflow.mdc`
- `tool-selection.mdc`
- `workspace-management.mdc`

This matches Cursor's convention and is filesystem-friendly.
